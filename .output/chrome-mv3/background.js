var background=function(){"use strict";var D=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function W(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var j={exports:{}};(function(e,g){(function(n,l){l(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:D,function(n){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)n.exports=globalThis.browser;else{const l="The message port closed before a response was received.",i=c=>{const t={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(t).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class h extends WeakMap{constructor(s,o=void 0){super(o),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const C=r=>r&&typeof r=="object"&&typeof r.then=="function",A=(r,s)=>(...o)=>{c.runtime.lastError?r.reject(new Error(c.runtime.lastError.message)):s.singleCallbackArg||o.length<=1&&s.singleCallbackArg!==!1?r.resolve(o[0]):r.resolve(o)},x=r=>r==1?"argument":"arguments",T=(r,s)=>function(m,...f){if(f.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${x(s.minArgs)} for ${r}(), got ${f.length}`);if(f.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${x(s.maxArgs)} for ${r}(), got ${f.length}`);return new Promise((b,p)=>{if(s.fallbackToNoCallback)try{m[r](...f,A({resolve:b,reject:p},s))}catch(a){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),m[r](...f),s.fallbackToNoCallback=!1,s.noCallback=!0,b()}else s.noCallback?(m[r](...f),b()):m[r](...f,A({resolve:b,reject:p},s))})},w=(r,s,o)=>new Proxy(s,{apply(m,f,b){return o.call(f,r,...b)}});let k=Function.call.bind(Object.prototype.hasOwnProperty);const R=(r,s={},o={})=>{let m=Object.create(null),f={has(p,a){return a in r||a in m},get(p,a,y){if(a in m)return m[a];if(!(a in r))return;let d=r[a];if(typeof d=="function")if(typeof s[a]=="function")d=w(r,r[a],s[a]);else if(k(o,a)){let P=T(a,o[a]);d=w(r,r[a],P)}else d=d.bind(r);else if(typeof d=="object"&&d!==null&&(k(s,a)||k(o,a)))d=R(d,s[a],o[a]);else if(k(o,"*"))d=R(d,s[a],o["*"]);else return Object.defineProperty(m,a,{configurable:!0,enumerable:!0,get(){return r[a]},set(P){r[a]=P}}),d;return m[a]=d,d},set(p,a,y,d){return a in m?m[a]=y:r[a]=y,!0},defineProperty(p,a,y){return Reflect.defineProperty(m,a,y)},deleteProperty(p,a){return Reflect.deleteProperty(m,a)}},b=Object.create(r);return new Proxy(b,f)},B=r=>({addListener(s,o,...m){s.addListener(r.get(o),...m)},hasListener(s,o){return s.hasListener(r.get(o))},removeListener(s,o){s.removeListener(r.get(o))}}),Y=new h(r=>typeof r!="function"?r:function(o){const m=R(o,{},{getContent:{minArgs:0,maxArgs:0}});r(m)}),_=new h(r=>typeof r!="function"?r:function(o,m,f){let b=!1,p,a=new Promise(M=>{p=function(v){b=!0,M(v)}}),y;try{y=r(o,m,p)}catch(M){y=Promise.reject(M)}const d=y!==!0&&C(y);if(y!==!0&&!d&&!b)return!1;const P=M=>{M.then(v=>{f(v)},v=>{let U;v&&(v instanceof Error||typeof v.message=="string")?U=v.message:U="An unexpected error occurred",f({__mozWebExtensionPolyfillReject__:!0,message:U})}).catch(v=>{console.error("Failed to send onMessage rejected reply",v)})};return P(d?y:a),!0}),ee=({reject:r,resolve:s},o)=>{c.runtime.lastError?c.runtime.lastError.message===l?s():r(new Error(c.runtime.lastError.message)):o&&o.__mozWebExtensionPolyfillReject__?r(new Error(o.message)):s(o)},q=(r,s,o,...m)=>{if(m.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${x(s.minArgs)} for ${r}(), got ${m.length}`);if(m.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${x(s.maxArgs)} for ${r}(), got ${m.length}`);return new Promise((f,b)=>{const p=ee.bind(null,{resolve:f,reject:b});m.push(p),o.sendMessage(...m)})},re={devtools:{network:{onRequestFinished:B(Y)}},runtime:{onMessage:B(_),onMessageExternal:B(_),sendMessage:q.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:q.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},N={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return t.privacy={network:{"*":N},services:{"*":N},websites:{"*":N}},R(c,re,t)};n.exports=i(chrome)}})})(j);var K=j.exports;const u=W(K);function z(e){return e==null||typeof e=="function"?{main:e}:e}async function $(){return new Promise((e,g)=>{var n;if(!((n=chrome==null?void 0:chrome.bookmarks)!=null&&n.getTree)){g(new Error("Bookmarks API not available"));return}chrome.bookmarks.getTree(l=>{const i=[];function c(t){t.url&&i.push({id:t.id,title:t.title||"无标题",url:t.url,dateAdded:t.dateAdded,parentId:t.parentId}),t.children&&t.children.forEach(c)}c(l[0]),e(i)})})}function Z(e,g){const n=(e+" "+g).toLowerCase();return/(work|job|office|company|business|meeting)/.test(n)?"工作":/(study|learn|course|tutorial|education|school|university)/.test(n)?"学习":/(entertainment|movie|music|game|fun|video)/.test(n)?"娱乐":/(news|press|journal|media)/.test(n)?"新闻":/(tech|development|programming|software|computer)/.test(n)?"技术":/(shop|buy|store|mall|purchase)/.test(n)?"购物":"其他"}function L(e){const g=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(l=>l.length>2),n=new Set(["the","and","or","but","in","on","at","to","for","of","with","by","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","should","could","can","may","might","must","this","that","these","those","then","than","from"]);return g.filter(l=>!n.has(l))}function G(e,g){if(e.length===0||g.length===0)return 0;const n=new Set(e),l=new Set(g),i=[...n].filter(t=>l.has(t)).length,c=n.size+l.size-i;return i/c}async function E(){const e=await chrome.storage.sync.get(["autoClassify","enableNotifications","enableRecommendations","checkInvalidBookmarks","checkFrequency","autoCleanDuplicates","defaultCategory","serverUrl","aiProvider","aiApiKey","aiModel","aiApiUrl","recommendationMode","userClassificationRules"]);return{autoClassify:e.autoClassify!==!1,enableNotifications:e.enableNotifications!==!1,enableRecommendations:e.enableRecommendations!==!1,checkInvalidBookmarks:e.checkInvalidBookmarks!==!1,checkFrequency:e.checkFrequency??"60",autoCleanDuplicates:!!e.autoCleanDuplicates,defaultCategory:e.defaultCategory??"其他",serverUrl:e.serverUrl??"http://localhost:5175",aiProvider:e.aiProvider??"deepseek",aiApiKey:e.aiApiKey??"",aiModel:e.aiModel??"deepseek-chat",aiApiUrl:e.aiApiUrl??"https://api.deepseek.com",recommendationMode:e.recommendationMode??"local",userClassificationRules:e.userClassificationRules??[]}}async function F(e){await chrome.storage.sync.set(e)}function H(e,g,n){const l=`${g} ${n}`;for(const i of e)try{if(new RegExp(i.pattern,"i").test(l))return i.category}catch{}}console.log("RainMark background (WXT) starting...");async function J(e){var g,n,l;try{const i=await u.bookmarks.getTree(),c=(n=(g=i==null?void 0:i[0])==null?void 0:g.children)==null?void 0:n[0];if(!c)return"1";let t=(l=c.children)==null?void 0:l.find(h=>h.title===e);return t||(t=await u.bookmarks.create({title:e,parentId:c.id})),t.id}catch(i){return console.error("Error getting category folder:",i),"1"}}async function V(){try{const e=await u.tabs.query({active:!0,currentWindow:!0});if(!e.length)return[];const g=e[0],n=await E();if(n.enableRecommendations===!1)return[];const l=L(`${g.title} ${g.url}`),t=(await $()).map(A=>{const x=L(`${A.title} ${A.url}`),T=G(l,x);return{...A,score:T,similarity:T}}).sort((A,x)=>x.score-A.score).slice(0,20),h=n.recommendationMode??"auto";if(h==="ai"||h==="auto"&&!!n.aiApiKey)try{const A=n.serverUrl||"http://localhost:5175",T=await(await fetch(`${A}/recommend`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({current:{title:g.title,url:g.url},candidates:t.map(k=>({id:k.id,title:k.title,url:k.url})),provider:n.aiProvider,apiKey:n.aiApiKey,apiUrl:n.aiApiUrl,model:n.aiModel,limit:5})})).json(),w=(T==null?void 0:T.recommendations)??[];if(Array.isArray(w)&&w.length)return w.map(k=>({...k,source:"AI"}))}catch{}return t.filter(A=>A.score>.3).slice(0,5).map(A=>({...A,source:"Local"}))}catch(e){return console.error("Error getting recommendations:",e),[]}}async function O(){var e;try{const g=await $(),n=[],l=g.slice(0,10),i=l.length;let c=0;try{await u.runtime.sendMessage({action:"checkProgress",current:0,total:i})}catch{}for(const t of l)if(t.url){try{const C=(await E()).serverUrl||"http://localhost:5175",x=await(await fetch(`${C}/check?url=${encodeURIComponent(t.url)}`)).json();x!=null&&x.valid||n.push(t)}catch{try{await fetch(t.url,{method:"HEAD",mode:"no-cors"})}catch{n.push(t)}}c++;try{await u.runtime.sendMessage({action:"checkProgress",current:c,total:i})}catch{}}if(n.length){let t=(await u.bookmarks.search({title:"失效链接"}))[0];t||(t=await u.bookmarks.create({title:"失效链接",parentId:"1"}));for(const C of n)try{await u.bookmarks.move(C.id,{parentId:t.id})}catch(A){console.error("Error moving invalid bookmark:",A)}(await E()).enableNotifications!==!1&&((e=u.notifications)==null||e.create({type:"basic",iconUrl:"icons/icon48.png",title:"RainMark 书签检查",message:`发现 ${n.length} 个失效链接，已移至"失效链接"文件夹`}))}return{success:!0,count:n.length}}catch(g){return console.error("Error checking invalid bookmarks:",g),{success:!1,error:(g==null?void 0:g.message)??String(g)}}}const X=z(()=>{var e,g,n;(e=u.bookmarks.onCreated)==null||e.addListener(async(l,i)=>{var c;try{const t=await E();if(t.autoClassify&&i.url){let h=H(t.userClassificationRules??[],i.title,i.url)??void 0;if(!h)try{const x=t.serverUrl||"http://localhost:5175",w=await(await fetch(`${x}/classify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:i.title,url:i.url,provider:t.aiProvider,apiKey:t.aiApiKey,apiUrl:t.aiApiUrl,model:t.aiModel})})).json();h=(w==null?void 0:w.category)||void 0}catch{}const C=h??Z(i.title,i.url),A=await J(C||t.defaultCategory||"其他");await u.bookmarks.move(l,{parentId:A}),t.enableNotifications!==!1&&((c=u.notifications)==null||c.create({type:"basic",iconUrl:"icons/icon48.png",title:"RainMark 书签分类",message:`已将 "${i.title}" 分类到 "${C}"`}))}}catch(t){console.error("Error processing bookmark creation:",t)}}),(g=u.runtime.onMessage)==null||g.addListener(l=>{switch(l.action){case"getRecommendations":return V();case"checkInvalidBookmarks":return O();case"getAllBookmarks":return $();case"getSettings":return E();case"setSettings":return(async()=>(await F(l.payload||{}),{success:!0}))();case"ping":return{status:"ok",version:"1.0.0"};default:return{error:"Unknown action"}}}),(n=u.runtime.onInstalled)==null||n.addListener(async()=>{var l,i,c;await F({autoClassify:!0,enableNotifications:!0,enableRecommendations:!0,checkInvalidBookmarks:!0,checkFrequency:"60",autoCleanDuplicates:!1,defaultCategory:"其他"}),(l=u.alarms)!=null&&l.create&&((c=(i=u.alarms)==null?void 0:i.onAlarm)!=null&&c.addListener)&&(u.alarms.create("checkInvalidBookmarks",{periodInMinutes:60}),u.alarms.onAlarm.addListener(async t=>{t.name==="checkInvalidBookmarks"&&(await E()).checkInvalidBookmarks!==!1&&await O()}))})});console.log("RainMark background (WXT) ready.");function te(){}function S(e,...g){}const Q={debug:(...e)=>S(console.debug,...e),log:(...e)=>S(console.log,...e),warn:(...e)=>S(console.warn,...e),error:(...e)=>S(console.error,...e)};let I;try{I=X.main(),I instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw Q.error("The background crashed on startup!"),e}return I}();
background;
