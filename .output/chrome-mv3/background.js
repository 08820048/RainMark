var background=function(){"use strict";var K=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function z(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var j={exports:{}};(function(e,o){(function(t,g){g(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:K,function(t){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)t.exports=globalThis.browser;else{const g="The message port closed before a response was received.",a=n=>{const m={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(m).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class h extends WeakMap{constructor(s,l=void 0){super(l),this.createItem=s}get(s){return this.has(s)||this.set(s,this.createItem(s)),super.get(s)}}const T=r=>r&&typeof r=="object"&&typeof r.then=="function",u=(r,s)=>(...l)=>{n.runtime.lastError?r.reject(new Error(n.runtime.lastError.message)):s.singleCallbackArg||l.length<=1&&s.singleCallbackArg!==!1?r.resolve(l[0]):r.resolve(l)},w=r=>r==1?"argument":"arguments",b=(r,s)=>function(c,...f){if(f.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${w(s.minArgs)} for ${r}(), got ${f.length}`);if(f.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${w(s.maxArgs)} for ${r}(), got ${f.length}`);return new Promise((x,p)=>{if(s.fallbackToNoCallback)try{c[r](...f,u({resolve:x,reject:p},s))}catch(i){console.warn(`${r} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),c[r](...f),s.fallbackToNoCallback=!1,s.noCallback=!0,x()}else s.noCallback?(c[r](...f),x()):c[r](...f,u({resolve:x,reject:p},s))})},E=(r,s,l)=>new Proxy(s,{apply(c,f,x){return l.call(f,r,...x)}});let k=Function.call.bind(Object.prototype.hasOwnProperty);const I=(r,s={},l={})=>{let c=Object.create(null),f={has(p,i){return i in r||i in c},get(p,i,y){if(i in c)return c[i];if(!(i in r))return;let d=r[i];if(typeof d=="function")if(typeof s[i]=="function")d=E(r,r[i],s[i]);else if(k(l,i)){let P=b(i,l[i]);d=E(r,r[i],P)}else d=d.bind(r);else if(typeof d=="object"&&d!==null&&(k(s,i)||k(l,i)))d=I(d,s[i],l[i]);else if(k(l,"*"))d=I(d,s[i],l["*"]);else return Object.defineProperty(c,i,{configurable:!0,enumerable:!0,get(){return r[i]},set(P){r[i]=P}}),d;return c[i]=d,d},set(p,i,y,d){return i in c?c[i]=y:r[i]=y,!0},defineProperty(p,i,y){return Reflect.defineProperty(c,i,y)},deleteProperty(p,i){return Reflect.deleteProperty(c,i)}},x=Object.create(r);return new Proxy(x,f)},N=r=>({addListener(s,l,...c){s.addListener(r.get(l),...c)},hasListener(s,l){return s.hasListener(r.get(l))},removeListener(s,l){s.removeListener(r.get(l))}}),re=new h(r=>typeof r!="function"?r:function(l){const c=I(l,{},{getContent:{minArgs:0,maxArgs:0}});r(c)}),D=new h(r=>typeof r!="function"?r:function(l,c,f){let x=!1,p,i=new Promise(S=>{p=function(v){x=!0,S(v)}}),y;try{y=r(l,c,p)}catch(S){y=Promise.reject(S)}const d=y!==!0&&T(y);if(y!==!0&&!d&&!x)return!1;const P=S=>{S.then(v=>{f(v)},v=>{let _;v&&(v instanceof Error||typeof v.message=="string")?_=v.message:_="An unexpected error occurred",f({__mozWebExtensionPolyfillReject__:!0,message:_})}).catch(v=>{console.error("Failed to send onMessage rejected reply",v)})};return P(d?y:i),!0}),se=({reject:r,resolve:s},l)=>{n.runtime.lastError?n.runtime.lastError.message===g?s():r(new Error(n.runtime.lastError.message)):l&&l.__mozWebExtensionPolyfillReject__?r(new Error(l.message)):s(l)},W=(r,s,l,...c)=>{if(c.length<s.minArgs)throw new Error(`Expected at least ${s.minArgs} ${w(s.minArgs)} for ${r}(), got ${c.length}`);if(c.length>s.maxArgs)throw new Error(`Expected at most ${s.maxArgs} ${w(s.maxArgs)} for ${r}(), got ${c.length}`);return new Promise((f,x)=>{const p=se.bind(null,{resolve:f,reject:x});c.push(p),l.sendMessage(...c)})},te={devtools:{network:{onRequestFinished:N(re)}},runtime:{onMessage:N(D),onMessageExternal:N(D),sendMessage:W.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:W.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},U={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return m.privacy={network:{"*":U},services:{"*":U},websites:{"*":U}},I(n,te,m)};t.exports=a(chrome)}})})(j);var Z=j.exports;const A=z(Z);function G(e){return e==null||typeof e=="function"?{main:e}:e}async function B(){return new Promise((e,o)=>{var t;if(!((t=chrome==null?void 0:chrome.bookmarks)!=null&&t.getTree)){o(new Error("Bookmarks API not available"));return}chrome.bookmarks.getTree(g=>{const a=[];function n(m){m.url&&a.push({id:m.id,title:m.title||"无标题",url:m.url,dateAdded:m.dateAdded,parentId:m.parentId}),m.children&&m.children.forEach(n)}n(g[0]),e(a)})})}function H(e,o){const t=(e+" "+o).toLowerCase();return/(work|job|office|company|business|meeting)/.test(t)?"工作":/(study|learn|course|tutorial|education|school|university)/.test(t)?"学习":/(entertainment|movie|music|game|fun|video)/.test(t)?"娱乐":/(news|press|journal|media)/.test(t)?"新闻":/(tech|development|programming|software|computer)/.test(t)?"技术":/(shop|buy|store|mall|purchase)/.test(t)?"购物":"其他"}function L(e){const o=e.toLowerCase().replace(/[^\w\s]/g," ").split(/\s+/).filter(g=>g.length>2),t=new Set(["the","and","or","but","in","on","at","to","for","of","with","by","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","should","could","can","may","might","must","this","that","these","those","then","than","from"]);return o.filter(g=>!t.has(g))}function J(e,o){if(e.length===0||o.length===0)return 0;const t=new Set(e),g=new Set(o),a=[...t].filter(m=>g.has(m)).length,n=t.size+g.size-a;return a/n}async function C(){const e=await chrome.storage.sync.get(["autoClassify","enableNotifications","enableRecommendations","checkInvalidBookmarks","checkFrequency","autoCleanDuplicates","defaultCategory","themeAccent","serverUrl","aiProvider","aiApiKey","aiModel","aiApiUrl","recommendationMode","userClassificationRules"]);return{autoClassify:e.autoClassify!==!1,enableNotifications:e.enableNotifications!==!1,enableRecommendations:e.enableRecommendations!==!1,checkInvalidBookmarks:e.checkInvalidBookmarks!==!1,checkFrequency:e.checkFrequency??"60",autoCleanDuplicates:!!e.autoCleanDuplicates,defaultCategory:e.defaultCategory??"其他",themeAccent:e.themeAccent??"rgba(0, 186, 189, 1)",serverUrl:e.serverUrl??"http://localhost:5175",aiProvider:e.aiProvider??"deepseek",aiApiKey:e.aiApiKey??"",aiModel:e.aiModel??"deepseek-chat",aiApiUrl:e.aiApiUrl??"https://api.deepseek.com",recommendationMode:e.recommendationMode??"local",userClassificationRules:e.userClassificationRules??[]}}async function F(e){await chrome.storage.sync.set(e)}function V(e,o,t){const g=`${o} ${t}`;for(const a of e)try{if(new RegExp(a.pattern,"i").test(g))return a.category}catch{}}console.log("RainMark background (WXT) starting...");function M(e,o){var t,g;try{const a=(g=(t=A==null?void 0:A.i18n)==null?void 0:t.getMessage)==null?void 0:g.call(t,e,o??[]);if(a)return a}catch{}return e}async function O(e){try{if((await C()).enableNotifications===!1)return;await A.runtime.sendMessage({action:"toast",payload:e})}catch{}}async function X(e){var o,t,g;try{const a=await A.bookmarks.getTree(),n=(t=(o=a==null?void 0:a[0])==null?void 0:o.children)==null?void 0:t[0];if(!n)return"1";let m=(g=n.children)==null?void 0:g.find(h=>h.title===e);return m||(m=await A.bookmarks.create({title:e,parentId:n.id})),m.id}catch(a){return console.error("Error getting category folder:",a),"1"}}async function Q(){try{const e=await A.tabs.query({active:!0,currentWindow:!0});if(!e.length)return[];const o=e[0],t=await C();if(t.enableRecommendations===!1)return[];const g=L(`${o.title} ${o.url}`),m=(await B()).map(u=>{const w=L(`${u.title} ${u.url}`),b=J(g,w);return{...u,score:b,similarity:b}}).sort((u,w)=>w.score-u.score).slice(0,20),h=t.recommendationMode??"auto";if(h==="ai"||h==="auto"&&!!t.aiApiKey)try{const u=t.serverUrl||"http://localhost:5175",b=await(await fetch(`${u}/recommend`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({current:{title:o.title,url:o.url},candidates:m.map(k=>({id:k.id,title:k.title,url:k.url})),provider:t.aiProvider,apiKey:t.aiApiKey,apiUrl:t.aiApiUrl,model:t.aiModel,limit:5})})).json(),E=(b==null?void 0:b.recommendations)??[];if(Array.isArray(E)&&E.length)return E.map(k=>({...k,source:"AI"}))}catch{}return m.slice(0,5).map(u=>({...u,source:"Local"}))}catch(e){return console.error("Error getting recommendations:",e),[]}}async function q(){try{const e=await B(),o=[],t=e.slice(0,10),g=t.length;let a=0;try{await A.runtime.sendMessage({action:"checkProgress",current:0,total:g})}catch{}for(const n of t)if(n.url){try{const h=(await C()).serverUrl||"http://localhost:5175",u=await(await fetch(`${h}/check?url=${encodeURIComponent(n.url)}`)).json();u!=null&&u.valid||o.push(n)}catch{try{await fetch(n.url,{method:"HEAD",mode:"no-cors"})}catch{o.push(n)}}a++;try{await A.runtime.sendMessage({action:"checkProgress",current:a,total:g})}catch{}}if(o.length){let n=(await A.bookmarks.search({title:"失效链接"}))[0];n||(n=await A.bookmarks.create({title:"失效链接",parentId:"1"}));for(const h of o)try{await A.bookmarks.move(h.id,{parentId:n.id})}catch(T){console.error("Error moving invalid bookmark:",T)}(await C()).enableNotifications!==!1&&await O({type:"info",title:M("bg_invalid_title"),message:M("bg_invalid_msg",[String(o.length)])})}return{success:!0,count:o.length}}catch(e){return console.error("Error checking invalid bookmarks:",e),{success:!1,error:(e==null?void 0:e.message)??String(e)}}}const Y=G(()=>{var e,o,t;(e=A.bookmarks.onCreated)==null||e.addListener(async(g,a)=>{try{const n=await C();if(n.autoClassify&&a.url){let m=V(n.userClassificationRules??[],a.title,a.url)??void 0;if(!m)try{const u=n.serverUrl||"http://localhost:5175",b=await(await fetch(`${u}/classify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:a.title,url:a.url,provider:n.aiProvider,apiKey:n.aiApiKey,apiUrl:n.aiApiUrl,model:n.aiModel})})).json();m=(b==null?void 0:b.category)||void 0}catch{}const h=m??H(a.title,a.url),T=await X(h||n.defaultCategory||"其他");await A.bookmarks.move(g,{parentId:T}),n.enableNotifications!==!1&&await O({type:"success",title:M("bg_classify_title"),message:M("bg_classify_msg",[String(a.title||""),String(h||"")])})}}catch(n){console.error("Error processing bookmark creation:",n)}}),(o=A.runtime.onMessage)==null||o.addListener(g=>{switch(g.action){case"getRecommendations":return Q();case"checkInvalidBookmarks":return q();case"getAllBookmarks":return B();case"getSettings":return C();case"setSettings":return(async()=>(await F(g.payload||{}),{success:!0}))();case"ping":return{status:"ok",version:"1.0.0"};default:return{error:"Unknown action"}}}),(t=A.runtime.onInstalled)==null||t.addListener(async()=>{var g,a,n;await F({autoClassify:!0,enableNotifications:!0,enableRecommendations:!0,checkInvalidBookmarks:!0,checkFrequency:"60",autoCleanDuplicates:!1,defaultCategory:"其他"}),(g=A.alarms)!=null&&g.create&&((n=(a=A.alarms)==null?void 0:a.onAlarm)!=null&&n.addListener)&&(A.alarms.create("checkInvalidBookmarks",{periodInMinutes:60}),A.alarms.onAlarm.addListener(async m=>{m.name==="checkInvalidBookmarks"&&(await C()).checkInvalidBookmarks!==!1&&await q()}))})});console.log("RainMark background (WXT) ready.");function ae(){}function R(e,...o){}const ee={debug:(...e)=>R(console.debug,...e),log:(...e)=>R(console.log,...e),warn:(...e)=>R(console.warn,...e),error:(...e)=>R(console.error,...e)};let $;try{$=Y.main(),$ instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw ee.error("The background crashed on startup!"),e}return $}();
background;
